name: "Automated Validation Workflow"

on: [pull_request]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v35

      - name: Ensure validation script is executable
        run: chmod +x .specify/scripts/validation/run-validation.sh

      - name: Run validation script
        id: run-validation # Added ID to the step
        run: .specify/scripts/validation/run-validation.sh ${{ steps.changed-files.outputs.all_changed_files }}

      - name: Process validation results
        id: process-results
        run: |
          VALIDATION_SUMMARY=$(cat validation_summary.txt)
          echo "validation_output<<EOF" >> $GITHUB_OUTPUT
          echo "$VALIDATION_SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "validation_status=${{ steps.run-validation.outcome }}" >> $GITHUB_OUTPUT

      - name: Post validation results as PR comment
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const validationOutput = `${{ steps.process-results.outputs.validation_output }}`;
            const validationStatus = `${{ steps.process-results.outputs.validation_status }}`;
            let commentBody = `### Automated Validation Results\n\n`;
            commentBody += `**Overall Status**: ${validationStatus === 'success' ? '✅ PASSED' : '❌ FAILED'}\n\n`;
            commentBody += `<details><summary>Validation Summary</summary>\n\n\`\`\`\n${validationOutput}\n\`\`\`\n</details>`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: Apply validation status label
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request' && steps.process-results.outputs.validation_status == 'failure'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['needs-improvement']
            });