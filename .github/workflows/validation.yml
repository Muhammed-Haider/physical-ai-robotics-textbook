name: Automated Validation Workflow

on:
  pull_request:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v35

      - name: Ensure validation script is executable
        run: chmod +x .specify/scripts/validation/run-validation.sh

      - name: Run validation script
        id: run-validation
        continue-on-error: true
        run: |
          .specify/scripts/validation/run-validation.sh \
          "${{ steps.changed-files.outputs.all_changed_files }}"

      - name: Process validation results
        id: process-results
        run: |
          if [ -f validation_summary.txt ]; then
            SUMMARY=$(cat validation_summary.txt)
          else
            SUMMARY="No validation summary generated."
          fi

          echo "validation_output<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "validation_status=${{ steps.run-validation.outcome }}" >> $GITHUB_OUTPUT

      - name: Post validation results as PR comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `${{ steps.process-results.outputs.validation_output }}`;
            const status = `${{ steps.process-results.outputs.validation_status }}`;

            const body = `
            ### Automated Validation Results

            **Overall Status:** ${status === 'success' ? '✅ PASSED' : '❌ FAILED'}

            <details>
            <summary>Validation Summary</summary>

            \`\`\`
            ${output}
            \`\`\`
            </details>
            `;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Apply validation failure label
        if: steps.process-results.outputs.validation_status == 'failure'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['needs-improvement']
            });
